<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Reviews - Traveling Tastebuds</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Chewy&display=swap" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <!-- Restaurant Database -->
    <script src="/data/restaurants.js"></script>

    <!-- Restaurant Card Component -->
    <script src="/components/RestaurantCard.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #FFFFFF;
            color: #1e3a8a;
        }
        .brand-font {
            font-family: 'Chewy', cursive;
        }

        /* Leaflet Customization */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content {
            margin: 0;
            width: 260px !important;
        }

        .card-highlight {
            animation: pulse-border 2s infinite;
            border-color: #60a5fa;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.3);
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(96, 165, 250, 0); }
            100% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0); }
        }

        html {
            scroll-behavior: smooth;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            blue: '#1e40af',
                            sky: '#60a5fa',
                            light: '#eff6ff',
                            white: '#ffffff'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { RestaurantCard, VideoModal } = window;
        const db = window.restaurantDB;

        // --- COMPONENTS ---

        const Logo = () => (
            <div className="w-14 h-14 relative group cursor-pointer">
                <img src="/Images/ttbLogo.png" alt="Traveling Tastebuds Logo" className="w-full h-full object-contain drop-shadow-md hover:scale-105 transition" />
            </div>
        );

        const Navbar = () => {
            useEffect(() => {
                lucide.createIcons();
            }, []);

            return (
                <nav className="sticky top-0 z-50 bg-white/95 backdrop-blur shadow-sm border-b border-gray-100">
                    <div className="max-w-7xl mx-auto px-4">
                        <div className="flex justify-between items-center h-20">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => window.location.href = '/'}>
                                <Logo />
                                <div className="hidden md:block">
                                    <h1 className="brand-font text-3xl text-brand-blue leading-none">Traveling</h1>
                                    <h1 className="brand-font text-3xl text-brand-sky leading-none">Tastebuds</h1>
                                </div>
                            </div>

                            <div className="hidden md:flex gap-8 items-center">
                                <button onClick={() => window.location.href = '/'} className="font-bold uppercase tracking-wide text-sm hover:text-brand-sky transition text-gray-500">
                                    Home
                                </button>
                                <button className="font-bold uppercase tracking-wide text-sm text-brand-blue border-b-2 border-brand-blue">
                                    Reviews
                                </button>
                                <button onClick={() => window.location.href = '/merch'} className="font-bold uppercase tracking-wide text-sm hover:text-brand-sky transition text-gray-500">
                                    Merch
                                </button>
                                <a href="https://www.tiktok.com/@the.traveling.tastebuds" target="_blank" rel="noopener noreferrer" className="bg-brand-blue text-white px-6 py-2 rounded-full font-bold hover:bg-blue-900 transition shadow-lg shadow-blue-200">
                                    Follow Us
                                </a>
                            </div>

                            <button className="md:hidden text-brand-blue">
                                <i data-lucide="menu" className="w-8 h-8"></i>
                            </button>
                        </div>
                    </div>
                </nav>
            );
        };

        const FoodReviewsPage = () => {
            const mapContainer = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef({});
            const [highlightedId, setHighlightedId] = useState(null);
            const [modalRestaurant, setModalRestaurant] = useState(null);
            const [activeFilter, setActiveFilter] = useState('All');
            const [restaurants, setRestaurants] = useState([]);
            const [filters, setFilters] = useState(['All']);

            useEffect(() => {
                // Load restaurants from database
                const loadedRestaurants = db.getAll();
                setRestaurants(loadedRestaurants);

                // Build filter list from unique types
                const types = db.getTypes();
                setFilters(['All', ...types]);

                lucide.createIcons();
            }, []);

            useEffect(() => {
                lucide.createIcons();
            }, [highlightedId, activeFilter, restaurants]);

            // Listen for storage events to update when database changes
            useEffect(() => {
                const handleStorageChange = () => {
                    const loadedRestaurants = db.getAll();
                    setRestaurants(loadedRestaurants);
                    const types = db.getTypes();
                    setFilters(['All', ...types]);

                    // Update map markers
                    if (mapInstance.current) {
                        updateMapMarkers(loadedRestaurants);
                    }
                };
                window.addEventListener('storage', handleStorageChange);
                return () => window.removeEventListener('storage', handleStorageChange);
            }, []);

            const scrollToCard = (id) => {
                setHighlightedId(id);
                const element = document.getElementById(`card-${id}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                setTimeout(() => setHighlightedId(null), 3000);
            };

            const updateMapMarkers = (restaurantList) => {
                if (!mapInstance.current) return;

                // Clear existing markers
                Object.values(markersRef.current).forEach(marker => {
                    mapInstance.current.removeLayer(marker);
                });
                markersRef.current = {};

                // Add new markers
                restaurantList.forEach(restaurant => {
                    if (restaurant.lat && restaurant.lng) {
                        const icon = L.divIcon({
                            className: 'custom-icon',
                            html: `<div style="background-color: #1e40af; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [32, 32]
                        });

                        const marker = L.marker([restaurant.lat, restaurant.lng], {icon}).addTo(mapInstance.current);

                        const popupContent = document.createElement('div');
                        popupContent.innerHTML = `
                            <div style="font-family: 'Poppins', sans-serif;">
                                <div style="padding: 12px;">
                                    <h3 style="color: #1e40af; font-weight: 700; margin: 0 0 4px 0;">${restaurant.name}</h3>
                                    <p style="color: #666; font-size: 12px; margin: 0 0 8px 0;">${restaurant.city}</p>
                                    <button id="btn-${restaurant.id}" style="width: 100%; background: #60a5fa; color: white; border: none; padding: 6px 10px; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 12px;">
                                        Go to Card ↓
                                    </button>
                                </div>
                            </div>
                        `;

                        marker.bindPopup(popupContent);
                        marker.on('popupopen', () => {
                            const btn = document.getElementById(`btn-${restaurant.id}`);
                            if(btn) {
                                btn.onclick = () => scrollToCard(restaurant.id);
                            }
                        });

                        markersRef.current[restaurant.id] = marker;
                    }
                });
            };

            useEffect(() => {
                if (mapContainer.current && !mapInstance.current && restaurants.length > 0) {
                    const map = L.map(mapContainer.current).setView([39.8, -74.9], 9);
                    mapInstance.current = map;

                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                        maxZoom: 20
                    }).addTo(map);

                    updateMapMarkers(restaurants);
                }
            }, [restaurants]);

            const filteredRestaurants = activeFilter === 'All'
                ? restaurants
                : restaurants.filter(r => r.type === activeFilter);

            return (
                <>
                    <Navbar />

                    {modalRestaurant && <VideoModal restaurant={modalRestaurant} onClose={() => setModalRestaurant(null)} />}

                    <div className="flex flex-col min-h-screen">
                        <div className="h-[40vh] md:h-[50vh] w-full relative z-10">
                            <div ref={mapContainer} className="w-full h-full"></div>
                            <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-lg z-[1000] text-xs font-bold text-brand-blue flex items-center gap-2">
                                <i data-lucide="mouse-pointer" className="w-4 h-4"></i> Click a pin to find the card below
                            </div>
                        </div>

                        <div className="flex-1 bg-white py-12 relative z-20">
                            <div className="max-w-7xl mx-auto px-4">
                                <div className="flex items-center justify-between mb-8 flex-wrap gap-4">
                                    <h2 className="brand-font text-4xl text-brand-blue">Review Feed ({filteredRestaurants.length})</h2>
                                    <div className="flex gap-2 flex-wrap">
                                        {filters.map(filter => (
                                            <button
                                                key={filter}
                                                onClick={() => setActiveFilter(filter)}
                                                className={`px-4 py-1 rounded-full border text-sm font-bold transition ${
                                                    activeFilter === filter
                                                        ? 'bg-brand-blue text-white border-brand-blue'
                                                        : 'border-gray-200 text-gray-500 hover:bg-brand-light hover:text-brand-blue'
                                                }`}
                                            >
                                                {filter}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {filteredRestaurants.length > 0 ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 pb-12">
                                        {filteredRestaurants.map(restaurant => (
                                            <RestaurantCard
                                                key={restaurant.id}
                                                restaurant={restaurant}
                                                isActive={highlightedId === restaurant.id}
                                                onOpenModal={setModalRestaurant}
                                            />
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-12">
                                        <i data-lucide="search-x" className="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                                        <p className="text-gray-500 text-lg">No restaurants found for this filter.</p>
                                        <p className="text-gray-400 text-sm mt-2">Try selecting a different category.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <footer className="bg-brand-blue text-white py-12 border-t border-blue-800">
                        <div className="max-w-7xl mx-auto px-4 text-center">
                            <div className="w-16 h-16 mx-auto mb-6 bg-white rounded-full flex items-center justify-center p-2">
                                <img src="/Images/ttbLogo.png" alt="Logo" className="w-full h-full object-contain" />
                            </div>
                            <h2 className="brand-font text-3xl mb-2">Traveling Tastebuds</h2>
                            <p className="text-blue-200 mb-8 max-w-md mx-auto">
                                Exploring the best food in NJ and beyond. Tag us to get featured!
                            </p>
                            <div className="flex justify-center gap-6 mb-8 flex-wrap">
                                <a href="https://www.instagram.com/the.traveling.tastebuds/" target="_blank" rel="noopener noreferrer" className="text-white hover:text-brand-sky font-bold text-sm uppercase tracking-widest">Instagram</a>
                                <a href="https://www.tiktok.com/@the.traveling.tastebuds" target="_blank" rel="noopener noreferrer" className="text-white hover:text-brand-sky font-bold text-sm uppercase tracking-widest">TikTok</a>
                                <a href="https://www.youtube.com/@travelingtastebuds5208" target="_blank" rel="noopener noreferrer" className="text-white hover:text-brand-sky font-bold text-sm uppercase tracking-widest">YouTube</a>
                                <a href="https://www.facebook.com/TTBReviews" target="_blank" rel="noopener noreferrer" className="text-white hover:text-brand-sky font-bold text-sm uppercase tracking-widest">Facebook</a>
                            </div>
                            <p className="text-blue-400 text-xs">© 2025 Traveling Tastebuds. All rights reserved.</p>
                        </div>
                    </footer>
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FoodReviewsPage />);
    </script>
</body>
</html>
