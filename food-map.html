<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Map | Traveling Tastebuds</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chewy&family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta name="description" content="Interactive food map showing every restaurant reviewed by Traveling Tastebuds in NJ and Philly.">
</head>

<body class="food-map-page">
    <!-- Navbar -->
    <script src="/navbar-loader.js"></script>

    <div class="food-map-container">
        <!-- Sidebar -->
        <div class="food-map-sidebar" id="mapSidebar">
            <div class="food-map-sidebar-header">
                <h5 style="color: var(--text-white); margin-bottom: 0.75rem; font-weight: 600;">
                    <i class="fas fa-utensils" style="color: var(--accent);"></i> TTB Food Map
                </h5>
                <div style="position: relative;">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="food-map-search" id="mapSearch" placeholder="Search spots...">
                </div>
            </div>
            <div class="food-map-list" id="mapList">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Map -->
        <div id="foodMap"></div>
    </div>

    <!-- TikTok Video Modal -->
    <div class="modal fade" id="tiktokModal" tabindex="-1" aria-labelledby="tiktokModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tiktokModalLabel">TikTok Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <iframe id="tiktokIframe" width="100%" height="600" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/ttb-data.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script>
        var allSpots = [];
        var markers = {};
        var activeSpot = null;
        var map;

        function createMarkerIcon(isActive) {
            var size = isActive ? 22 : 16;
            var half = isActive ? 11 : 8;
            return L.divIcon({
                className: 'custom-marker',
                html: '<div style="width:' + size + 'px;height:' + size + 'px;background:' + (isActive ? '#f7a94b' : '#1e40af') + ';border-radius:50%;border:3px solid white;box-shadow:0 2px 12px rgba(0,0,0,0.15);transition:all 0.3s ease;"></div>',
                iconSize: [size, size], iconAnchor: [half, half]
            });
        }

        // Loading state
        document.getElementById('mapList').innerHTML =
            '<div style="padding:1.5rem;text-align:center;color:var(--text-muted);"><i class="fas fa-spinner fa-spin" style="font-size:1.5rem;margin-bottom:0.5rem;display:block;"></i>Loading spots...</div>';

        (async function loadMap() {
            map = L.map('foodMap', { zoomControl: true }).setView([39.83, -75.08], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
                maxZoom: 19
            }).addTo(map);

            try {
                allSpots = await TTBData.getSpots();
            } catch (err) {
                console.error('Failed to load spots:', err);
                document.getElementById('mapList').innerHTML =
                    '<div style="padding:2rem;text-align:center;color:var(--text-muted);"><i class="fas fa-exclamation-triangle" style="font-size:1.5rem;color:var(--accent);display:block;margin-bottom:0.5rem;"></i>Could not load spots. Please refresh.</div>';
                return;
            }

            var mapList = document.getElementById('mapList');
            mapList.innerHTML = '';

            if (!allSpots.length) {
                mapList.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--text-muted);">No spots yet â€” check back soon!</div>';
                return;
            }

            var esc = TTBData.escapeHtml;
            var safeTikTok = TTBData.sanitizeTikTokId;

            allSpots.forEach(function (spot, index) {
                if (!spot.lat || !spot.lng) return;

                var marker = L.marker([spot.lat, spot.lng], { icon: createMarkerIcon(false) }).addTo(map);
                var videoId = safeTikTok(spot.tiktokId);

                marker.bindPopup(
                    '<div class="ttb-map-popup"><h3>' + esc(spot.name) + '</h3><p>' + esc(spot.location) + '</p>' +
                    '<div class="popup-tags">' + (spot.tags || []).map(function (t) { return '<span class="popup-tag">' + esc(t) + '</span>'; }).join('') + '</div>' +
                    (spot.discount ? '<div class="popup-discount"><i class="fas fa-tag"></i> ' + esc(spot.discount) + '</div>' : '') +
                    '<p style="font-size:0.8rem;color:#888;margin:0.3rem 0;">' + esc(spot.snippet || '') + '</p>' +
                    '<button class="popup-btn" data-video="' + videoId + '" data-name="' + esc(spot.name) + '"><i class="fab fa-tiktok"></i> Watch Review</button></div>',
                    { maxWidth: 280, className: 'ttb-popup' }
                );

                marker.on('popupopen', function () {
                    var btn = document.querySelector('.ttb-map-popup .popup-btn[data-video="' + videoId + '"]');
                    if (btn) btn.addEventListener('click', function () { openTikTokModal(this.dataset.video, this.dataset.name); });
                });

                markers[index] = marker;
                marker.on('click', function () { selectSpot(index); });

                var item = document.createElement('div');
                item.className = 'food-map-item';
                item.setAttribute('data-index', index);
                item.innerHTML =
                    '<img src="' + esc(spot.logoImage || '') + '" alt="' + esc(spot.name) + '" class="food-map-item-img">' +
                    '<div class="food-map-item-info"><h4>' + esc(spot.name) + '</h4>' +
                    '<p><i class="fas fa-map-marker-alt" style="color:var(--accent);"></i> ' + esc(spot.location) + '</p>' +
                    (spot.discount ? '<div class="food-map-item-discount"><i class="fas fa-tag"></i> ' + esc(spot.discount) + '</div>' : '') +
                    '</div>';
                item.addEventListener('click', function () { selectSpot(index); });
                mapList.appendChild(item);
            });
        })();

        function selectSpot(index) {
            if (activeSpot !== null) {
                markers[activeSpot].setIcon(createMarkerIcon(false));
                var prev = document.querySelector('.food-map-item[data-index="' + activeSpot + '"]');
                if (prev) prev.classList.remove('active');
            }
            activeSpot = index;
            var spot = allSpots[index];
            markers[index].setIcon(createMarkerIcon(true));
            var item = document.querySelector('.food-map-item[data-index="' + index + '"]');
            if (item) { item.classList.add('active'); item.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
            map.flyTo([spot.lat, spot.lng], 14, { duration: 0.8 });
            markers[index].openPopup();
        }

        document.getElementById('mapSearch').addEventListener('input', function () {
            var q = this.value.toLowerCase();
            document.querySelectorAll('.food-map-item').forEach(function (item, i) {
                var spot = allSpots[i];
                if (!spot) { item.style.display = 'none'; return; }
                var matches = spot.name.toLowerCase().includes(q) || spot.location.toLowerCase().includes(q) ||
                    (spot.tags || []).some(function (t) { return t.toLowerCase().includes(q); });
                item.style.display = matches ? 'flex' : 'none';
            });
        });

        function openTikTokModal(videoId, name) {
            document.getElementById('tiktokModalLabel').textContent = name + ' - TikTok Review';
            document.getElementById('tiktokIframe').src = 'https://www.tiktok.com/embed/' + TTBData.sanitizeTikTokId(videoId);
            new bootstrap.Modal(document.getElementById('tiktokModal')).show();
        }

        document.getElementById('tiktokModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('tiktokIframe').src = '';
        });
    </script>
</body>

</html>
